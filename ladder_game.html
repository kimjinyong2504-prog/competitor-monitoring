<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë‹¤ë¦¬ ê²Œì„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .setup-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .names-grid,
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .ladder-container {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            overflow: visible;
            width: 100%;
        }

        .ladder-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 500px;
            position: relative;
            padding: 20px 50px;
            width: 100%;
            overflow: visible;
        }

        .ladder-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 0 40px;
            min-width: 140px;
        }

        .name-box,
        .result-box {
            width: 140px;
            padding: 15px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .result-box {
            margin-top: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .ladder-line {
            width: 5px;
            background: #000;
            position: relative;
            flex: 1;
            min-height: 400px;
        }

        .rung {
            position: absolute;
            height: 5px;
            background: #000;
            z-index: 2;
        }

        .rung.left {
            left: -100px;
            width: 100px;
        }

        .rung.right {
            right: -100px;
            width: 100px;
        }

        .ball {
            width: 28px;
            height: 28px;
            background: #ff0000;
            border-radius: 50%;
            position: absolute;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
            border: 2px solid white;
        }

        .result-display {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 15px;
            text-align: center;
            display: none;
        }

        .result-display.show {
            display: block;
        }

        .result-item {
            margin: 10px 0;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .hidden {
            display: none;
        }

        .reset-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ² ì‚¬ë‹¤ë¦¬ ê²Œì„ ğŸ²</h1>
        
        <div class="setup-section" id="setupSection">
            <div class="input-group">
                <label for="playerCount">ì¸ì›ìˆ˜ ì„¤ì •</label>
                <input type="number" id="playerCount" min="2" max="20" value="4" onchange="updateInputs()">
            </div>
            
            <div class="input-group">
                <label>ì°¸ê°€ì ì´ë¦„</label>
                <div class="names-grid" id="namesGrid">
                    <input type="text" placeholder="ì°¸ê°€ì 1" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <input type="text" placeholder="ì°¸ê°€ì 2" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <input type="text" placeholder="ì°¸ê°€ì 3" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <input type="text" placeholder="ì°¸ê°€ì 4" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                </div>
            </div>
            
            <div class="input-group">
                <label>ê²°ê³¼ í•­ëª©</label>
                <div class="results-grid" id="resultsGrid">
                    <input type="text" placeholder="ê²°ê³¼ 1" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <input type="text" placeholder="ê²°ê³¼ 2" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <input type="text" placeholder="ê²°ê³¼ 3" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <input type="text" placeholder="ê²°ê³¼ 4" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                </div>
            </div>
            
            <button onclick="generateLadder()">ì‚¬ë‹¤ë¦¬ ìƒì„±í•˜ê¸°</button>
        </div>
        
        <div class="ladder-container hidden" id="ladderContainer">
            <div class="ladder-wrapper" id="ladderWrapper"></div>
            <button onclick="startGame()">ì‚¬ë‹¤ë¦¬ íƒ€ê¸° ì‹œì‘!</button>
        </div>
        
        <div class="result-display" id="resultDisplay">
            <h2>ğŸ‰ ê²°ê³¼ ë°œí‘œ ğŸ‰</h2>
            <div id="resultContent"></div>
            <button class="reset-btn" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <script>
        let playerCount = 4;
        let names = [];
        let results = [];
        let ladderData = [];
        let balls = [];
        let targetMapping = []; // ê° ì°¸ê°€ìê°€ ë„ì°©í•  ëª©í‘œ ì—´

        function updateInputs() {
            try {
                const playerCountInput = document.getElementById('playerCount');
                if (!playerCountInput) {
                    console.error('playerCount ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                playerCount = parseInt(playerCountInput.value) || 2;
                if (playerCount < 2) playerCount = 2;
                if (playerCount > 20) playerCount = 20;
                
                const namesGrid = document.getElementById('namesGrid');
                const resultsGrid = document.getElementById('resultsGrid');
                
                if (!namesGrid || !resultsGrid) {
                    console.error('namesGrid ë˜ëŠ” resultsGridë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ê¸°ì¡´ ì…ë ¥ í•„ë“œì—ì„œ ê°’ ì½ê¸°
                const existingNameInputs = namesGrid.querySelectorAll('input');
                const existingResultInputs = resultsGrid.querySelectorAll('input');
                
                for (let i = 0; i < Math.min(existingNameInputs.length, playerCount); i++) {
                    names[i] = existingNameInputs[i].value || '';
                }
                for (let i = 0; i < Math.min(existingResultInputs.length, playerCount); i++) {
                    results[i] = existingResultInputs[i].value || '';
                }
                
                // ê¸°ì¡´ ë‚´ìš© ì œê±°
                namesGrid.innerHTML = '';
                resultsGrid.innerHTML = '';
                
                // ì…ë ¥ í•„ë“œ ìƒì„±
                for (let i = 0; i < playerCount; i++) {
                    // ì°¸ê°€ì ì´ë¦„ ì…ë ¥
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.placeholder = `ì°¸ê°€ì ${i + 1}`;
                    nameInput.value = names[i] || '';
                    nameInput.oninput = function() {
                        names[i] = this.value || `ì°¸ê°€ì ${i + 1}`;
                    };
                    namesGrid.appendChild(nameInput);
                    
                    // ê²°ê³¼ ì…ë ¥
                    const resultInput = document.createElement('input');
                    resultInput.type = 'text';
                    resultInput.placeholder = `ê²°ê³¼ ${i + 1}`;
                    resultInput.value = results[i] || '';
                    resultInput.oninput = function() {
                        results[i] = this.value || `ê²°ê³¼ ${i + 1}`;
                    };
                    resultsGrid.appendChild(resultInput);
                }
                
                names = names.slice(0, playerCount);
                results = results.slice(0, playerCount);
            } catch (error) {
                console.error('updateInputs ì˜¤ë¥˜:', error);
            }
        }

        function generateLadder() {
            try {
                console.log('ì‚¬ë‹¤ë¦¬ ìƒì„± ì‹œì‘');
                
                const nameInputs = document.querySelectorAll('#namesGrid input');
                const resultInputs = document.querySelectorAll('#resultsGrid input');
                
                console.log('ì°¸ê°€ì ì…ë ¥ í•„ë“œ:', nameInputs.length);
                console.log('ê²°ê³¼ ì…ë ¥ í•„ë“œ:', resultInputs.length);
                
                if (nameInputs.length === 0 || resultInputs.length === 0) {
                    alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                names = [];
                results = [];
                
                nameInputs.forEach((input, i) => {
                    names[i] = input.value || `ì°¸ê°€ì ${i + 1}`;
                });
                
                resultInputs.forEach((input, i) => {
                    results[i] = input.value || `ê²°ê³¼ ${i + 1}`;
                });
                
                // ì¸ì›ìˆ˜ í™•ì¸
                playerCount = names.length;
                if (playerCount < 2) {
                    alert('ìµœì†Œ 2ëª… ì´ìƒì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
                
                console.log('ì°¸ê°€ì:', names);
                console.log('ê²°ê³¼:', results);
                
                // ê²°ê³¼ë¥¼ ì„ì–´ì„œ ê° ì°¸ê°€ìì—ê²Œ í• ë‹¹
                results = shuffleArray([...results]);
                
                // ì‚¬ë‹¤ë¦¬ ìƒì„±
                createLadder();
                
                // í™”ë©´ ì „í™˜
                const setupSection = document.getElementById('setupSection');
                const ladderContainer = document.getElementById('ladderContainer');
                
                if (setupSection && ladderContainer) {
                    setupSection.classList.add('hidden');
                    ladderContainer.classList.remove('hidden');
                    console.log('ì‚¬ë‹¤ë¦¬ ìƒì„± ì™„ë£Œ');
                } else {
                    console.error('setupSection ë˜ëŠ” ladderContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ë‹¤ë¦¬ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ì‚¬ë‹¤ë¦¬ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function createLadder() {
            try {
                console.log('createLadder ì‹œì‘, playerCount:', playerCount);
                
                // NAVER ë°©ì‹: ì‚¬ë‹¤ë¦¬ë¥¼ ìƒì„±í•  ë•Œë¶€í„° ê° ì°¸ê°€ìê°€ ì„œë¡œ ë‹¤ë¥¸ ëª©ì ì§€ì— ë„ì°©í•˜ë„ë¡ ë³´ì¥
                let attempts = 0;
                const maxAttempts = 50;
                
                while (attempts < maxAttempts) {
                const wrapper = document.getElementById('ladderWrapper');
                wrapper.innerHTML = '';
                
                ladderData = [];
                balls = [];
                
                // ê° ì°¸ê°€ìê°€ ë„ì°©í•  ëª©í‘œ ì—´ ê²°ì • (1:1 ë§¤í•‘)
                targetMapping = [];
                const available = [];
                for (let i = 0; i < playerCount; i++) {
                    available.push(i);
                }
                // ì„ê¸°
                for (let i = 0; i < playerCount; i++) {
                    const randomIndex = Math.floor(Math.random() * available.length);
                    targetMapping[i] = available.splice(randomIndex, 1)[0];
                }
                
                // ê°€ë¡œëŒ€ ìœ„ì¹˜ ìƒì„± (ë” ë§ì€ ê°€ë¡œëŒ€)
                const rungCount = Math.floor(Math.random() * 12) + 10;
                const rungPositions = [];
                for (let i = 0; i < rungCount; i++) {
                    rungPositions.push(0.1 + Math.random() * 0.8);
                }
                rungPositions.sort();
                
                // ê° ì—´ ì‚¬ì´ ì—°ê²° ê²°ì •
                const connections = [];
                for (let i = 0; i < playerCount - 1; i++) {
                    connections[i] = [];
                }
                
                // ê° ì°¸ê°€ìê°€ ëª©í‘œ ì—´ì— ë„ì°©í•˜ë„ë¡ ê°€ë¡œëŒ€ ë°°ì¹˜
                for (let startCol = 0; startCol < playerCount; startCol++) {
                    const targetCol = targetMapping[startCol];
                    
                    if (startCol !== targetCol) {
                        // ëª©í‘œ ì—´ê¹Œì§€ ì´ë™ ê²½ë¡œ ìƒì„±
                        const steps = Math.abs(targetCol - startCol);
                        const direction = startCol < targetCol ? 'right' : 'left';
                        
                        // ê° ë‹¨ê³„ë§ˆë‹¤ ê°€ë¡œëŒ€ ë°°ì¹˜
                        for (let step = 0; step < steps; step++) {
                            const colIdx = direction === 'right' ? startCol + step : startCol - 1 - step;
                            if (colIdx >= 0 && colIdx < playerCount - 1) {
                                // ê° ë‹¨ê³„ë§ˆë‹¤ ë‹¤ë¥¸ ìœ„ì¹˜ì— ê°€ë¡œëŒ€ ë°°ì¹˜
                                const pos = 0.15 + (step + 1) * 0.7 / (steps + 1) + Math.random() * 0.1;
                                
                                // ê¸°ì¡´ ê°€ë¡œëŒ€ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ í™•ì¸
                                const tooClose = connections[colIdx].some(p => Math.abs(p - pos) < 0.1);
                                if (!tooClose) {
                                    connections[colIdx].push(pos);
                                }
                            }
                        }
                    }
                }
                
                // ì¶”ê°€ ëœë¤ ê°€ë¡œëŒ€ (ì‹œê°ì  íš¨ê³¼, í•˜ì§€ë§Œ ê²½ë¡œë¥¼ ë°©í•´í•˜ì§€ ì•Šë„ë¡)
                for (let i = 0; i < playerCount - 1; i++) {
                    rungPositions.forEach(pos => {
                        if (Math.random() > 0.8 && !connections[i].includes(pos)) {
                            connections[i].push(pos);
                        }
                    });
                }
                
                // ê° ì—°ê²° ë°°ì—´ ì •ë ¬
                for (let i = 0; i < playerCount - 1; i++) {
                    connections[i].sort();
                }
            
                // ì‚¬ë‹¤ë¦¬ êµ¬ì¡° ìƒì„±
                for (let i = 0; i < playerCount; i++) {
                    const column = document.createElement('div');
                    column.className = 'ladder-column';
                    column.id = `col-${i}`;
                    
                    const nameBox = document.createElement('div');
                    nameBox.className = 'name-box';
                    nameBox.textContent = names[i];
                    column.appendChild(nameBox);
                    
                    const line = document.createElement('div');
                    line.className = 'ladder-line';
                    line.id = `line-${i}`;
                    
                    const rungs = [];
                    
                    // ì™¼ìª½ ê°€ë¡œëŒ€
                    if (i > 0 && connections[i - 1]) {
                        connections[i - 1].forEach(pos => {
                            const rung = document.createElement('div');
                            rung.className = 'rung left';
                            rung.style.top = `${pos * 100}%`;
                            line.appendChild(rung);
                            rungs.push({ pos: pos, dir: 'left' });
                        });
                    }
                    
                    // ì˜¤ë¥¸ìª½ ê°€ë¡œëŒ€
                    if (i < playerCount - 1 && connections[i]) {
                        connections[i].forEach(pos => {
                            const rung = document.createElement('div');
                            rung.className = 'rung right';
                            rung.style.top = `${pos * 100}%`;
                            line.appendChild(rung);
                            rungs.push({ pos: pos, dir: 'right' });
                        });
                    }
                    
                    rungs.sort((a, b) => a.pos - b.pos);
                    
                    column.appendChild(line);
                    
                    const resultBox = document.createElement('div');
                    resultBox.className = 'result-box';
                    resultBox.textContent = results[i];
                    resultBox.id = `result-${i}`;
                    column.appendChild(resultBox);
                    
                    wrapper.appendChild(column);
                    
                    // ê³µ ìƒì„±
                    const ball = document.createElement('div');
                    ball.className = 'ball';
                    ball.id = `ball-${i}`;
                    wrapper.appendChild(ball);
                    
                    setTimeout(() => {
                        const nameBoxRect = nameBox.getBoundingClientRect();
                        const wrapperRect = wrapper.getBoundingClientRect();
                        const lineRect = line.getBoundingClientRect();
                        
                        ball.style.position = 'absolute';
                        ball.style.left = (lineRect.left + lineRect.width / 2 - wrapperRect.left - 14) + 'px';
                        ball.style.top = (nameBoxRect.bottom - wrapperRect.top + 5) + 'px';
                    }, 50);
                    
                    balls.push({
                        el: ball,
                        startCol: i,
                        col: i
                    });
                    
                    ladderData.push({ rungs: rungs });
                }
                
                // ì‹¤ì œ ê²°ê³¼ ê³„ì‚° ë° ê²€ì¦
                const actualCols = [];
                for (let i = 0; i < playerCount; i++) {
                    actualCols[i] = calcResult(i);
                }
                
                // ì¤‘ë³µ í™•ì¸
                const usedCols = new Set();
                let hasDuplicate = false;
                for (let i = 0; i < playerCount; i++) {
                    if (usedCols.has(actualCols[i])) {
                        hasDuplicate = true;
                        break;
                    }
                    usedCols.add(actualCols[i]);
                }
                
                // ì¤‘ë³µì´ ì—†ìœ¼ë©´ ì™„ë£Œ
                if (!hasDuplicate) {
                    // ê²°ê³¼ ë°•ìŠ¤ë¥¼ ì‹¤ì œ ë„ì°© ì—´ì— ë§ê²Œ ì¬ë°°ì¹˜
                    const colToResult = new Array(playerCount);
                    for (let i = 0; i < playerCount; i++) {
                        colToResult[actualCols[i]] = results[targetMapping[i]];
                    }
                    
                    for (let i = 0; i < playerCount; i++) {
                        const resultBox = document.getElementById(`result-${i}`);
                        if (resultBox && colToResult[i] !== undefined) {
                            resultBox.textContent = colToResult[i];
                        }
                    }
                    
                    // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                    setTimeout(() => {
                        for (let i = 0; i < playerCount - 1; i++) {
                            if (connections[i] && connections[i].length > 0) {
                                connections[i].forEach(pos => {
                                    const leftLine = document.getElementById(`line-${i}`);
                                    const rightLine = document.getElementById(`line-${i + 1}`);
                                    if (leftLine && rightLine) {
                                        const connector = document.createElement('div');
                                        connector.style.position = 'absolute';
                                        connector.style.height = '5px';
                                        connector.style.background = '#000';
                                        connector.style.zIndex = '1';
                                        
                                        const leftRect = leftLine.getBoundingClientRect();
                                        const rightRect = rightLine.getBoundingClientRect();
                                        const wrapperRect = wrapper.getBoundingClientRect();
                                        
                                        const top = leftRect.top + (leftRect.height * pos) - wrapperRect.top;
                                        const left = leftRect.right - wrapperRect.left;
                                        const width = rightRect.left - leftRect.right;
                                        
                                        connector.style.top = top + 'px';
                                        connector.style.left = left + 'px';
                                        connector.style.width = width + 'px';
                                        
                                        wrapper.appendChild(connector);
                                    }
                                });
                            }
                        }
                    }, 100);
                    
                    console.log('ì‚¬ë‹¤ë¦¬ ìƒì„± ì„±ê³µ (ì‹œë„ íšŸìˆ˜:', attempts + 1, ')');
                    return; // ì„±ê³µì ìœ¼ë¡œ ìƒì„± ì™„ë£Œ
                }
                
                // ì¤‘ë³µì´ ìˆìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
                attempts++;
                console.log('ì¤‘ë³µ ë°œê²¬, ì¬ì‹œë„... (', attempts, '/', maxAttempts, ')');
            }
            
            // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ê²½ê³ 
            console.warn('ì‚¬ë‹¤ë¦¬ ìƒì„± ì‹¤íŒ¨: ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
            alert('ì‚¬ë‹¤ë¦¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } catch (error) {
                console.error('createLadder ì˜¤ë¥˜:', error);
                alert('ì‚¬ë‹¤ë¦¬ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function startGame() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'ì§„í–‰ ì¤‘...';
            
            // ê²°ê³¼ ë¯¸ë¦¬ ê³„ì‚° (ì‚¬ë‹¤ë¦¬ êµ¬ì¡°ì— ë”°ë¼)
            const actualCols = [];
            for (let i = 0; i < playerCount; i++) {
                actualCols[i] = calcResult(i);
            }
            
            // ì‹¤ì œ ë„ì°© ì—´ì— ë§ê²Œ ê²°ê³¼ ë°•ìŠ¤ ì¬ë°°ì¹˜
            // ê° ì°¸ê°€ìê°€ ë„ì°©í•˜ëŠ” ì‹¤ì œ ì—´ì— ê·¸ ì°¸ê°€ìì˜ ëª©í‘œ ê²°ê³¼ë¥¼ ë°°ì¹˜
            rearrangeResultsToActual(actualCols);
            
            // ì• ë‹ˆë©”ì´ì…˜ì€ ì‹¤ì œ ê³„ì‚°ëœ ê²½ë¡œë¥¼ ë”°ë¼ê°
            await Promise.all(balls.map((ball, idx) => animateBall(idx, actualCols[idx])));
            
            // ê²°ê³¼ í‘œì‹œëŠ” ì‹¤ì œ ë„ì°© ì—´ ê¸°ì¤€
            showResultsByActual(actualCols);
            
            btn.disabled = false;
            btn.textContent = 'ì‚¬ë‹¤ë¦¬ íƒ€ê¸° ì‹œì‘!';
        }
        
        // ì‹¤ì œ ë„ì°© ì—´ì— ë§ê²Œ ê²°ê³¼ ë°•ìŠ¤ ì¬ë°°ì¹˜
        function rearrangeResultsToActual(actualCols) {
            // ê° ì°¸ê°€ìê°€ ë„ì°©í•˜ëŠ” ì‹¤ì œ ì—´ì— ê·¸ ì°¸ê°€ìì˜ ëª©í‘œ ê²°ê³¼ë¥¼ ë°°ì¹˜
            // í•˜ì§€ë§Œ ê° ì—´ì— í•˜ë‚˜ì”©ë§Œ ë°°ì¹˜ë˜ë„ë¡ ë³´ì¥
            
            const colToResult = new Array(playerCount).fill(null);
            const colToPlayers = {}; // ê° ì—´ì— ë„ì°©í•˜ëŠ” ì°¸ê°€ìë“¤
            
            // ê° ì°¸ê°€ìê°€ ë„ì°©í•˜ëŠ” ì—´ ìˆ˜ì§‘
            for (let i = 0; i < playerCount; i++) {
                const actualCol = actualCols[i];
                if (!colToPlayers[actualCol]) {
                    colToPlayers[actualCol] = [];
                }
                colToPlayers[actualCol].push(i);
            }
            
            // ê° ì—´ì— ê²°ê³¼ ë°°ì¹˜
            // ê°™ì€ ì—´ì— ì—¬ëŸ¬ ì°¸ê°€ìê°€ ë„ì°©í•˜ë©´, ì²« ë²ˆì§¸ ì°¸ê°€ìì˜ ëª©í‘œ ê²°ê³¼ ì‚¬ìš©
            for (let col = 0; col < playerCount; col++) {
                if (colToPlayers[col] && colToPlayers[col].length > 0) {
                    const firstPlayer = colToPlayers[col][0];
                    colToResult[col] = results[targetMapping[firstPlayer]];
                }
            }
            
            // ì‚¬ìš©ë˜ì§€ ì•Šì€ ì—´ ì²˜ë¦¬
            const usedResults = new Set();
            for (let i = 0; i < playerCount; i++) {
                if (colToResult[i] !== null) {
                    usedResults.add(colToResult[i]);
                }
            }
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ê²°ê³¼ ì°¾ê¸°
            const availableResults = [];
            for (let i = 0; i < playerCount; i++) {
                if (!usedResults.has(results[i])) {
                    availableResults.push(results[i]);
                }
            }
            
            // ì‚¬ìš©ë˜ì§€ ì•Šì€ ì—´ì— ë‚¨ì€ ê²°ê³¼ ë°°ì¹˜
            let availIndex = 0;
            for (let col = 0; col < playerCount; col++) {
                if (colToResult[col] === null && availIndex < availableResults.length) {
                    colToResult[col] = availableResults[availIndex++];
                }
            }
            
            // ëª¨ë“  ì—´ì— ê²°ê³¼ê°€ ë°°ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
            for (let i = 0; i < playerCount; i++) {
                if (colToResult[i] === null) {
                    colToResult[i] = results[i];
                }
            }
            
            // ê²°ê³¼ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            for (let i = 0; i < playerCount; i++) {
                const resultBox = document.getElementById(`result-${i}`);
                if (resultBox) {
                    resultBox.textContent = colToResult[i];
                }
            }
        }
        
        // ì‹¤ì œ ë„ì°© ì—´ ê¸°ì¤€ìœ¼ë¡œ ê²°ê³¼ í‘œì‹œ
        function showResultsByActual(actualCols) {
            const display = document.getElementById('resultDisplay');
            const content = document.getElementById('resultContent');
            
            content.innerHTML = '';
            
            // ê° ì°¸ê°€ìê°€ ë„ì°©í•œ ì‹¤ì œ ì—´ì˜ ê²°ê³¼ ë°•ìŠ¤ ë‚´ìš© í‘œì‹œ
            for (let i = 0; i < playerCount; i++) {
                const actualCol = actualCols[i];
                const resultBox = document.getElementById(`result-${actualCol}`);
                const resultText = resultBox ? resultBox.textContent : results[i];
                
                const item = document.createElement('div');
                item.className = 'result-item';
                item.textContent = `${names[i]} â†’ ${resultText}`;
                content.appendChild(item);
            }
            
            display.classList.add('show');
        }

        function calcResult(startCol) {
            let col = startCol;
            let pos = 0;
            
            // ì‚¬ë‹¤ë¦¬ë¥¼ íƒ€ë©° ì´ë™ ì‹œë®¬ë ˆì´ì…˜
            while (pos < 0.99) {
                // í˜„ì¬ ì—´ì—ì„œ ë§Œë‚  ìˆ˜ ìˆëŠ” ë‹¤ìŒ ê°€ë¡œëŒ€ ì°¾ê¸°
                const next = ladderData[col].rungs
                    .filter(r => r.pos > pos)
                    .sort((a, b) => a.pos - b.pos)[0];
                
                if (next) {
                    pos = next.pos;
                    // ê°€ë¡œëŒ€ë¥¼ ë”°ë¼ ì˜† ì—´ë¡œ ì´ë™
                    if (next.dir === 'right' && col < playerCount - 1) {
                        col++;
                    } else if (next.dir === 'left' && col > 0) {
                        col--;
                    }
                } else {
                    // ë” ì´ìƒ ê°€ë¡œëŒ€ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ì—´ì— ë¨¸ë¬´ë¦„
                    break;
                }
            }
            
            return col;
        }

        async function animateBall(idx, finalCol) {
            const ball = balls[idx];
            let col = ball.startCol;
            let pos = 0;
            
            const wrapper = document.getElementById('ladderWrapper');
            const wrapperRect = wrapper.getBoundingClientRect();
            
            // ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì´ë¦„ ë°•ìŠ¤ ë°”ë¡œ ì•„ë˜ë¡œ ì„¤ì •
            const nameBox = document.querySelector(`#col-${col} .name-box`);
            const startLine = document.getElementById(`line-${col}`);
            
            if (nameBox && startLine) {
                const nameBoxRect = nameBox.getBoundingClientRect();
                const lineRect = startLine.getBoundingClientRect();
                ball.el.style.position = 'absolute';
                ball.el.style.left = (lineRect.left + lineRect.width / 2 - wrapperRect.left - 14) + 'px';
                ball.el.style.top = (nameBoxRect.bottom - wrapperRect.top + 5) + 'px';
            }
            
            // ì´ë™
            while (pos < 0.99) {
                const next = ladderData[col].rungs
                    .filter(r => r.pos > pos)
                    .sort((a, b) => a.pos - b.pos)[0];
                
                if (next) {
                    const line = document.getElementById(`line-${col}`);
                    const lineRect = line.getBoundingClientRect();
                    
                    await moveDown(ball.el, pos, next.pos, lineRect, wrapperRect);
                    pos = next.pos;
                    
                    if (next.dir === 'right' && col < playerCount - 1) {
                        await moveRight(ball.el, col, col + 1, pos);
                        col++;
                    } else if (next.dir === 'left' && col > 0) {
                        await moveLeft(ball.el, col, col - 1, pos);
                        col--;
                    }
                } else {
                    const line = document.getElementById(`line-${col}`);
                    const lineRect = line.getBoundingClientRect();
                    await moveDown(ball.el, pos, 1, lineRect, wrapperRect);
                    break;
                }
            }
            
            // ê²°ê³¼ë¡œ ì´ë™
            const resultBox = document.getElementById(`result-${finalCol}`);
            const resultRect = resultBox.getBoundingClientRect();
            ball.el.style.left = (resultRect.left + resultRect.width / 2 - wrapperRect.left - 14) + 'px';
            ball.el.style.top = (resultRect.top + resultRect.height / 2 - wrapperRect.top - 14) + 'px';
        }

        function moveDown(el, from, to, lineRect, wrapperRect) {
            return new Promise(resolve => {
                const startY = lineRect.top + (lineRect.height * from) - wrapperRect.top - 14;
                const endY = lineRect.top + (lineRect.height * to) - wrapperRect.top - 14;
                const dist = Math.abs(endY - startY);
                const dur = Math.max(200, dist * 1.5);
                
                let start = null;
                function anim(now) {
                    if (!start) start = now;
                    const prog = Math.min((now - start) / dur, 1);
                    el.style.top = (startY + (endY - startY) * prog) + 'px';
                    if (prog < 1) {
                        requestAnimationFrame(anim);
                    } else {
                        resolve();
                    }
                }
                requestAnimationFrame(anim);
            });
        }

        function moveRight(el, fromCol, toCol, pos) {
            return new Promise(resolve => {
                const wrapper = document.getElementById('ladderWrapper');
                const wrapperRect = wrapper.getBoundingClientRect();
                const fromLine = document.getElementById(`line-${fromCol}`);
                const toLine = document.getElementById(`line-${toCol}`);
                const fromRect = fromLine.getBoundingClientRect();
                const toRect = toLine.getBoundingClientRect();
                
                const startX = fromRect.left + fromRect.width / 2 - wrapperRect.left - 14;
                const endX = toRect.left + toRect.width / 2 - wrapperRect.left - 14;
                const dist = Math.abs(endX - startX);
                const dur = Math.max(150, dist * 1.2);
                
                let start = null;
                function anim(now) {
                    if (!start) start = now;
                    const prog = Math.min((now - start) / dur, 1);
                    el.style.left = (startX + (endX - startX) * prog) + 'px';
                    if (prog < 1) {
                        requestAnimationFrame(anim);
                    } else {
                        resolve();
                    }
                }
                requestAnimationFrame(anim);
            });
        }

        function moveLeft(el, fromCol, toCol, pos) {
            return moveRight(el, fromCol, toCol, pos);
        }


        function resetGame() {
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('ladderContainer').classList.add('hidden');
            document.getElementById('resultDisplay').classList.remove('show');
            
            ladderData = [];
            balls = [];
            targetMapping = [];
            updateInputs();
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (onchangeì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
        window.updateInputs = updateInputs;
        window.generateLadder = generateLadder;
        window.startGame = startGame;
        window.resetGame = resetGame;
        
        // ì´ˆê¸°í™” í•¨ìˆ˜
        function init() {
            const namesGrid = document.getElementById('namesGrid');
            const resultsGrid = document.getElementById('resultsGrid');
            
            if (namesGrid && resultsGrid) {
                console.log('ì´ˆê¸°í™” ì‹œì‘');
                updateInputs();
                console.log('ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
                console.log('ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ì¬ì‹œë„...');
                // ìš”ì†Œê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
                setTimeout(init, 100);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        if (document.readyState === 'complete') {
            // ì´ë¯¸ ë¡œë“œ ì™„ë£Œëœ ê²½ìš°
            setTimeout(init, 0);
        } else if (document.readyState === 'loading') {
            // ì•„ì§ ë¡œë”© ì¤‘ì¸ ê²½ìš°
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(init, 0);
            });
        } else {
            // interactive ìƒíƒœ
            setTimeout(init, 0);
        }
        
        // ì¶”ê°€ ë³´ì¥ì„ ìœ„í•´ load ì´ë²¤íŠ¸ì—ë„ ë“±ë¡
        window.addEventListener('load', function() {
            setTimeout(init, 0);
        });
    </script>
</body>
</html>